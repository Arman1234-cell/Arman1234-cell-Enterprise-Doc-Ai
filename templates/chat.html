<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AI Chatroom | PDF Knowledge Base</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="app-container">

    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>üìÑ Upload PDF</h2>

        <input
            type="file"
            id="pdfInput"
            accept="application/pdf"
            onchange="updateFileName(this)"
        />

        <p id="fileName">No file selected</p>

        <button id="uploadBtn" onclick="uploadPDF()">
            Upload & Index
        </button>
    </aside>

    <!-- Chat Section -->
    <main class="chat-section">
        <header class="chat-header">
            <h2>Enterprise Doc AI</h2>
        </header>

        <div id="chatBox" class="chat-box"></div>

        <div class="chat-input">
            <input
                type="text"
                id="userQuery"
                placeholder="Ask something about your document..."
                onkeydown="if(event.key === 'Enter') askQuestion()"
            />
            <button id="sendBtn" onclick="askQuestion()">Send</button>
        </div>
    </main>

</div>

<!-- ================== JAVASCRIPT ================== -->
<script>
/* -------------------------------
   Add message to chat UI
-------------------------------- */
function addMessage(sender, text) {
    const chatBox = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = sender === "user" ? "user-msg" : "bot-msg";
    msg.innerText = text;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
}

/* -------------------------------
   Ask Question (Chat)
-------------------------------- */
async function askQuestion() {
    const input = document.getElementById("userQuery");
    const sendBtn = document.getElementById("sendBtn");
    const query = input.value.trim();

    if (!query) return;

    addMessage("user", query);
    input.value = "";
    sendBtn.disabled = true;
    sendBtn.innerText = "...";

    try {
        const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: query })
        });

        const data = await response.json();

        if (data.error) {
            addMessage("bot", "‚ö†Ô∏è " + data.error);
        } else {
            addMessage("bot", data.response);
        }
    } catch (err) {
        addMessage("bot", "‚ùå Server error. Please refresh.");
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerText = "Send";
    }
}

/* -------------------------------
   Show selected file name
-------------------------------- */
function updateFileName(input) {
    const label = document.getElementById("fileName");
    if (input.files.length > 0) {
        label.innerText = input.files[0].name;
    } else {
        label.innerText = "No file selected";
    }
}

/* -------------------------------
   Upload PDF to Backend
-------------------------------- */
async function uploadPDF() {
    const fileInput = document.getElementById("pdfInput");

    if (!fileInput.files.length) {
        alert("Please select a PDF file first");
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
        const response = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (!response.ok || data.error) {
            alert("‚ùå Upload failed: " + (data.error || "Unknown error"));
            return;
        }

        alert("‚úÖ PDF indexed successfully!");
        console.log("Tags:", data.tags);

    } catch (err) {
        console.error(err);
        alert("‚ùå Server error during upload");
    }
}
</script>

</body>
</html>
