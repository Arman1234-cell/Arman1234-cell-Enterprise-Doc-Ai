<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Chatroom | PDF Knowledge Base</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

    <!-- ========== SIDEBAR (UNCHANGED UI) ========== -->
    <div class="sidebar">
        <h2>Upload PDF</h2>

        <input
            type="file"
            id="pdfInput"
            accept="application/pdf"
            onchange="updateFileName(this)"
        >

        <p id="fileName">No file selected</p>

        <button onclick="uploadPDF()">Upload & Index</button>
    </div>

    <!-- ========== CHAT SECTION (UNCHANGED UI) ========== -->
    <div class="chat-container">
        <div class="chat-header">
            <h2>Enterprise Doc AI</h2>
        </div>

        <div id="chatBox" class="chat-box"></div>

        <div class="chat-input">
            <input
                type="text"
                id="userQuery"
                placeholder="Ask something..."
                onkeydown="if(event.key==='Enter') askQuestion()"
            >
            <button id="sendBtn" onclick="askQuestion()">Send</button>
        </div>
    </div>

</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
/* --------------------------------
   Chat UI helper
-------------------------------- */
function addMessage(sender, text) {
    const chatBox = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = sender === "user" ? "user-msg" : "bot-msg";
    msg.innerText = text;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
}

/* --------------------------------
   Ask Question (FIXED)
-------------------------------- */
async function askQuestion() {
    const input = document.getElementById("userQuery");
    const sendBtn = document.getElementById("sendBtn");
    const query = input.value.trim();
    if (!query) return;

    addMessage("user", query);
    input.value = "";
    sendBtn.disabled = true;
    sendBtn.innerText = "...";

    try {
        const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: query })
        });

        const data = await response.json();

        if (data.error) {
            addMessage("bot", "⚠️ " + data.error);
        } else {
            addMessage("bot", data.response);
        }
    } catch (err) {
        addMessage("bot", "❌ Server error. Please refresh.");
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerText = "Send";
    }
}

/* --------------------------------
   REQUIRED: show filename
-------------------------------- */
function updateFileName(input) {
    const label = document.getElementById("fileName");
    if (!label) return;

    if (input.files && input.files.length > 0) {
        label.innerText = input.files[0].name;
    } else {
        label.innerText = "No file selected";
    }
}

/* --------------------------------
   REQUIRED: upload PDF
-------------------------------- */
async function uploadPDF() {
    const fileInput = document.getElementById("pdfInput");

    if (!fileInput || !fileInput.files.length) {
        alert("Please select a PDF file first");
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
        const response = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (!response.ok || data.error) {
            alert(data.error || "Upload failed");
            return;
        }

        alert("✅ PDF uploaded and indexed successfully");
    } catch (err) {
        console.error(err);
        alert("❌ Server error during upload");
    }
}
</script>

</body>
</html>
